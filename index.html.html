<!doctype html>
<html lang="zh-CN">
<head>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="æ—¥å†å›">
<link rel="apple-touch-icon" href="icon.png.jpg">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DwJ Â· æ—¥å†å›ä¿¡æœº</title>
  <style>
    :root{
      --bg1:#ffe9f3;
      --bg2:#f3f7ff;
      --card:#ffffffcc;
      --ink:#1f2430;
      --muted:#6b7280;
      --pink:#ff5aa6;
      --pink2:#ff87c3;
      --blue:#5aa7ff;
      --line:#e7e7ee;
      --shadow: 0 10px 30px rgba(20,20,40,.12);
      --radius:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text","PingFang SC","Hiragino Sans GB","Noto Sans CJK SC","Microsoft Yahei", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1400px 700px at 15% 0%, rgba(255, 120, 195, .45), transparent 65%),
        radial-gradient(1400px 700px at 85% 8%, rgba(120, 180, 255, .38), transparent 65%),
        radial-gradient(1200px 600px at 50% 100%, rgba(255, 200, 220, .32), transparent 70%),
        linear-gradient(180deg, #ffe5f3, #f0f7ff);
      min-height:100vh;
      overflow-x:hidden;
      position: relative;
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><text y="20" font-size="20">ğŸ’—</text></svg>'), auto;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      opacity:.4;
      background-image:
        radial-gradient(circle at 12px 12px, rgba(255,90,166,.45) 2.5px, transparent 3.2px),
        radial-gradient(circle at 28px 20px, rgba(90,170,255,.35) 2.0px, transparent 2.8px),
        radial-gradient(circle at 8px 32px, rgba(255,200,120,.38) 2.2px, transparent 3.0px),
        radial-gradient(circle at 38px 38px, rgba(220,150,255,.32) 1.8px, transparent 2.6px),
        radial-gradient(circle at 18px 48px, rgba(150,255,200,.28) 1.6px, transparent 2.4px);
      background-size:48px 48px;
      filter: blur(.3px);
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-8px); }
    }

    body::after{
      content:"";
      position:fixed;
      inset:-80px;
      pointer-events:none;
      z-index:0;
      opacity:.45;
      background:
        radial-gradient(320px 220px at 12% 18%, rgba(255,140,200,.65), transparent 75%),
        radial-gradient(300px 210px at 88% 12%, rgba(140,200,255,.58), transparent 75%),
        radial-gradient(290px 200px at 25% 88%, rgba(255,220,180,.48), transparent 78%),
        radial-gradient(340px 240px at 82% 85%, rgba(200,170,255,.52), transparent 78%),
        radial-gradient(280px 190px at 50% 50%, rgba(255,190,230,.42), transparent 75%);
      filter: blur(3px);
      animation: pulse 8s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: .45; }
      50% { opacity: .55; }
    }

    body > *{
      position: relative;
      z-index: 1;
    }

    /* ğŸŠ é£˜è½emoji */
    .falling-emoji{
      position:fixed;
      pointer-events:none;
      font-size:24px;
      z-index:9999;
      animation: fall linear forwards;
      opacity:.7;
    }

    @keyframes fall {
      0% { transform: translateY(-50px) rotate(0deg); opacity:.7; }
      100% { transform: translateY(100vh) rotate(360deg); opacity:0; }
    }

    /* ğŸ’— ç‚¹å‡»ç²’å­ */
    .particle{
      position:fixed;
      pointer-events:none;
      font-size:20px;
      z-index:1000;
      animation: particleFly 1.2s ease-out forwards;
    }

    @keyframes particleFly {
      0% { transform: translate(0, 0) scale(1); opacity:1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity:0; }
    }

    /* ğŸ‰ ç¤¼èŠ± */
    .confetti{
      position:fixed;
      pointer-events:none;
      width:10px;
      height:10px;
      z-index:9999;
      animation: confettiFall var(--duration) ease-out forwards;
    }

    @keyframes confettiFall {
      0% { 
        transform: translate(0, 0) rotate(0deg); 
        opacity:1; 
      }
      100% { 
        transform: translate(var(--tx), var(--ty)) rotate(var(--rotate)); 
        opacity:0; 
      }
    }

    /* ğŸ“³ éœ‡åŠ¨ */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* ğŸŒŠ æ¶Ÿæ¼ª */
    .ripple{
      position:absolute;
      border-radius:50%;
      border:2px solid rgba(255,90,166,.6);
      pointer-events:none;
      animation: rippleSpread .8s ease-out forwards;
    }

    @keyframes rippleSpread {
      0% { width:0; height:0; opacity:1; }
      100% { width:100px; height:100px; opacity:0; }
    }

    .stickers{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:0;
      opacity:.16;
    }
    .st{
      position:absolute;
      font-weight:900;
      filter: drop-shadow(0 10px 24px rgba(20,20,40,.15));
      transform: rotate(var(--r));
      user-select:none;
      letter-spacing:.08em;
      animation: wobble 6s ease-in-out infinite;
    }
    .st:nth-child(odd){ color: rgba(255,90,166,.7); }
    .st:nth-child(even){ color: rgba(90,170,255,.7); }
    .st small{
      display:block;
      font-weight:800;
      opacity:.75;
      letter-spacing:.18em;
      margin-top:2px;
      font-size:.7em;
    }

    @keyframes wobble {
      0%, 100% { transform: rotate(var(--r)) translateY(0); }
      25% { transform: rotate(calc(var(--r) + 2deg)) translateY(-3px); }
      75% { transform: rotate(calc(var(--r) - 2deg)) translateY(3px); }
    }

    .wrap{
      position:relative;
      z-index:1;
      max-width:720px;
      margin:0 auto;
      padding:18px 14px 98px;
    }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px 6px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
      flex: 1;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      background:
        linear-gradient(135deg, rgba(255,140,195,.65) 0%, rgba(140,200,255,.55) 50%, rgba(200,170,255,.6) 100%);
      border:2px solid rgba(255,255,255,.85);
      box-shadow: 
        0 10px 28px rgba(255,90,166,.22),
        inset 0 0 0 1px rgba(255,255,255,.5);
      backdrop-filter: blur(14px) saturate(1.2);
      width: 100%;
      animation: glow 3s ease-in-out infinite;
      position:relative;
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 10px 28px rgba(255,90,166,.22), inset 0 0 0 1px rgba(255,255,255,.5); }
      50% { box-shadow: 0 12px 32px rgba(255,90,166,.35), inset 0 0 0 1px rgba(255,255,255,.6), 0 0 20px rgba(255,140,195,.3); }
    }

    /* ğŸ”¥ ç¡®ä¿emojiä¸è¢«é®æŒ¡ */
    .icons{
      font-size:18px;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.08));
      white-space:nowrap;
      position:relative;
      z-index:10;
    }
    .title{
      font-weight:900;
      letter-spacing:.2px;
      line-height:1.05;
      background: linear-gradient(135deg, #ff5aa6, #5aa7ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle{
      font-size:12px;
      color:var(--muted);
      margin-top:3px;
    }
    
    .rightpill{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:nowrap;
      min-width:0;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:linear-gradient(135deg, rgba(255,200,220,.8), rgba(200,220,255,.8));
      border:1px solid rgba(255,255,255,.85);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      white-space:nowrap;
      flex:0 0 auto;
      font-size:12px;
      color:var(--muted);
    }
    .pill b{ 
      background: linear-gradient(135deg, #ff5aa6, #5aa7ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight:900;
    }

    @media (max-width: 430px){
      .rightpill{ gap:8px; }
      .pill{ font-size:10.5px; padding:8px 9px; }
    }
    @media (max-width: 380px){
      .pill{ font-size:9.5px; padding:7px 8px; }
    }

    .card{
      margin-top:10px;
      background:linear-gradient(135deg, rgba(255,240,250,.85), rgba(240,250,255,.85));
      border:2px solid rgba(255,255,255,.85);
      border-radius:var(--radius);
      box-shadow:
        0 15px 40px rgba(20,20,40,.15),
        inset 0 0 0 1px rgba(255,255,255,.4);
      backdrop-filter: blur(16px) saturate(1.2);
      overflow:hidden;
      position:relative;
    }
    
    .card::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,140,195,.15), transparent 60%),
        radial-gradient(circle at 80% 70%, rgba(140,200,255,.12), transparent 60%);
      pointer-events:none;
      opacity:.8;
    }

    .card-inner{ padding:16px; position:relative; z-index:1; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row.center{ align-items:center; }

    .spacer{ height:10px; }

    .controls{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
    }
    @media (max-width:520px){
      .controls{ grid-template-columns:1fr; }
    }

    .input{
      width:100%;
      padding:14px 14px;
      border-radius:18px;
      border:2px solid rgba(255,200,220,.4);
      outline:none;
      background:linear-gradient(135deg, rgba(255,250,253,.95), rgba(250,253,255,.95));
      font-size:16px;
      transition: all .3s ease;
      box-shadow: 0 4px 12px rgba(255,140,195,.08);
    }
    .input:focus{
      border-color: rgba(255,90,166,.6);
      box-shadow: 
        0 0 0 4px rgba(255,90,166,.15),
        0 8px 20px rgba(255,140,195,.2),
        inset 0 0 20px rgba(255,200,220,.3);
      transform: translateY(-1px);
    }

    .btn{
      padding:14px 16px;
      border-radius:18px;
      border:none;
      cursor:pointer;
      font-weight:850;
      letter-spacing:.2px;
      background:linear-gradient(135deg, #ff5aa6, #ff87c3, #5aa7ff);
      background-size:200% 100%;
      color:white;
      box-shadow: 
        0 12px 25px rgba(255,90,166,.25),
        inset 0 0 0 1px rgba(255,255,255,.3);
      user-select:none;
      transition: all .3s ease;
    }
    .btn:hover{ 
      box-shadow: 
        0 14px 30px rgba(255,90,166,.4),
        0 0 30px rgba(255,140,195,.4),
        inset 0 0 0 1px rgba(255,255,255,.5);
      transform: translateY(-2px);
      background-position: 100% 0;
    }
    .btn:active{ transform: translateY(0) scale(.98); }
    
    .btn-ghost{
      padding:12px 14px;
      border-radius:16px;
      border:2px solid rgba(255,140,195,.3);
      background:linear-gradient(135deg, rgba(255,240,250,.9), rgba(240,250,255,.9));
      cursor:pointer;
      font-weight:750;
      color:var(--ink);
      transition: all .3s ease;
      box-shadow: 0 4px 12px rgba(255,140,195,.1);
    }
    .btn-ghost:hover{ 
      background:linear-gradient(135deg, rgba(255,230,245,.95), rgba(230,245,255,.95));
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(255,140,195,.2);
      border-color: rgba(255,90,166,.5);
    }
    .btn-ghost:active{ transform: translateY(0) scale(.98); }

    .btn-surprise{
      background:linear-gradient(135deg, #ff87c3, #ffb5d8, #ffd4e8);
      background-size:200% 100%;
      animation: rainbow 3s ease infinite;
    }

    @keyframes rainbow {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .small{ font-size:12px; color:var(--muted); }

    .divider{
      height:1px;
      background:linear-gradient(90deg, transparent, rgba(255,140,195,.3), transparent);
      margin:12px 0;
    }

    #calendarCard{
      position:relative;
      background:
        linear-gradient(135deg, rgba(240,245,255,.88), rgba(245,240,255,.88)),
        radial-gradient(520px 260px at 12% 12%, rgba(140,190,255,.28), transparent 70%),
        radial-gradient(520px 260px at 88% 18%, rgba(180,160,255,.25), transparent 70%);
      border:2.5px solid rgba(255,255,255,.85);
      box-shadow: 
        0 14px 40px rgba(90,120,200,.18),
        inset 0 0 0 1px rgba(255,255,255,.4);
    }
    
    #calendarCard::before{
      content:"ğŸº ğŸ’— ğŸ¦â€â¬› ğŸº ğŸ’— ğŸ¦â€â¬› ğŸº ğŸ’— ğŸ¦â€â¬› ğŸº ğŸ’— ğŸ¦â€â¬›";
      position:absolute;
      top:50%;
      left:0;
      right:0;
      transform: translateY(-50%);
      text-align:center;
      font-size:16px;
      opacity:.2;
      pointer-events:none;
      letter-spacing:12px;
      animation: slideWave 20s linear infinite;
      white-space:nowrap;
      line-height:1;
    }

    @keyframes slideWave {
      0% { 
        transform: translateY(-50%) translateX(0); 
        filter: hue-rotate(0deg);
      }
      100% { 
        transform: translateY(-50%) translateX(-200px); 
        filter: hue-rotate(360deg);
      }
    }

    .calbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    
    .month-nav{
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .month-arrow{
      padding:8px 10px;
      border-radius:12px;
      border:2px solid transparent;
      background:
        linear-gradient(rgba(240,250,255,.9), rgba(250,240,255,.9)) padding-box,
        linear-gradient(135deg, rgba(255,140,195,.6), rgba(140,190,255,.6)) border-box;
      cursor:pointer;
      font-weight:900;
      font-size:16px;
      user-select:none;
      transition: all .3s ease;
      box-shadow: 0 4px 10px rgba(140,190,255,.15);
    }
    .month-arrow:hover{ 
      transform: scale(1.15) rotate(10deg);
      box-shadow: 
        0 6px 14px rgba(140,190,255,.25),
        0 0 20px rgba(255,140,195,.3);
    }
    .month-arrow:active{ transform: scale(.95); }
    
    select{
      appearance:none;
      padding:10px 14px;
      border-radius:14px;
      border:2px solid transparent;
      background:
        linear-gradient(135deg, rgba(255,245,250,.95), rgba(245,250,255,.95)) padding-box,
        linear-gradient(135deg, rgba(255,140,195,.5), rgba(140,190,255,.5), rgba(255,200,220,.5)) border-box;
      font-weight:800;
      cursor:pointer;
      transition: all .3s ease;
      box-shadow: 0 4px 12px rgba(255,140,195,.12);
      position:relative;
    }
    select:hover{
      transform: translateY(-2px) scale(1.05);
      box-shadow: 
        0 6px 16px rgba(255,140,195,.22),
        0 0 25px rgba(255,140,195,.25);
      animation: selectGlow 1s ease infinite;
    }

    @keyframes selectGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.1); }
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
      margin-top:12px;
    }
    
    .dow{
      text-align:center;
      font-size:11px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.05em;
    }

    .day{
      aspect-ratio: 1 / 1;
      border-radius:16px;
      border:2px solid rgba(140,190,255,.2);
      background:linear-gradient(135deg, rgba(255,250,253,.85), rgba(250,253,255,.85));
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      cursor:pointer;
      position:relative;
      overflow:visible;
      transition: all .2s ease;
      box-shadow: 0 2px 8px rgba(140,190,255,.1);
    }
    .day:hover{ 
      border-color: rgba(255,90,166,.5);
      box-shadow: 
        0 6px 18px rgba(255,90,166,.25),
        0 0 20px rgba(255,140,195,.2);
      transform: translateY(-2px) scale(1.05);
    }
    .day:active{ 
      transform: translateY(0) scale(.95);
    }
    .day.off{
      opacity:.35;
      cursor:default;
    }
    .day.today{
      outline:2.5px solid rgba(255,90,166,.55);
      background: linear-gradient(135deg, rgba(255,240,250,.95), rgba(255,250,253,.95));
      box-shadow: 
        0 0 0 4px rgba(255,90,166,.12),
        0 8px 20px rgba(255,90,166,.2);
      animation: todayPulse 2s ease-in-out infinite;
    }

    @keyframes todayPulse {
      0%, 100% { box-shadow: 0 0 0 4px rgba(255,90,166,.12), 0 8px 20px rgba(255,90,166,.2); }
      50% { box-shadow: 0 0 0 6px rgba(255,90,166,.18), 0 10px 25px rgba(255,90,166,.3); }
    }
    
    /* ğŸŒ¸ å§¨å¦ˆæœŸæ ·å¼ */
    .day.period{
      border-color: rgba(255,105,180,.5);
      background:linear-gradient(135deg, rgba(255,192,203,.6), rgba(255,182,193,.6));
      position:relative;
    }
    .day.period::after{
      content:"ğŸŒ¸";
      position:absolute;
      top:-8px;
      right:-8px;
      font-size:14px;
      animation: periodPulse 2s ease-in-out infinite;
    }

    @keyframes periodPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    .day.emoji{
      font-size:26px;
      font-weight:800;
      line-height:1;
      font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji", var(--sans);
      animation: bounce 1.5s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.15) rotate(-5deg); }
      50% { transform: scale(1.08) rotate(0deg); }
      75% { transform: scale(1.15) rotate(5deg); }
    }

    .paper{
      position:relative;
      padding:18px;
      border-radius:26px;
      overflow:hidden;
      background:
        linear-gradient(135deg, rgba(255,245,252,.75), rgba(245,252,255,.75)),
        radial-gradient(540px 280px at 14% 8%,  rgba(255,160,210,.35), transparent 66%),
        radial-gradient(540px 280px at 86% 12%, rgba(150,210,255,.32), transparent 68%);
      border:2.5px dashed rgba(255,140,195,.35);
      box-shadow:
        0 20px 50px rgba(20,20,40,.14),
        inset 0 0 0 1px rgba(255,255,255,.42);
      backdrop-filter: blur(16px) saturate(1.15);
    }

    .paper::before{
      content:"";
      position:absolute; inset:-25px;
      pointer-events:none;
      opacity:.98;
      background:
        radial-gradient(150px 95px at 8% 12%, rgba(255,255,255,.65), transparent 72%),
        radial-gradient(190px 115px at 24% 6%, rgba(255,255,255,.62), transparent 74%),
        radial-gradient(180px 110px at 44% 10%, rgba(255,255,255,.58), transparent 74%),
        radial-gradient(210px 125px at 68% 8%, rgba(255,255,255,.60), transparent 76%),
        radial-gradient(170px 105px at 88% 14%, rgba(255,255,255,.56), transparent 74%),
        radial-gradient(540px 260px at 16% 28%, rgba(255,140,200,.22), transparent 68%),
        radial-gradient(540px 260px at 84% 32%, rgba(140,200,255,.18), transparent 68%),
        radial-gradient(circle at 16px 16px, rgba(255,90,166,.28) 1.6px, transparent 2.8px),
        radial-gradient(circle at 38px 28px, rgba(90,170,255,.24) 1.4px, transparent 2.6px);
      background-size:
        auto, auto, auto, auto, auto,
        auto, auto,
        54px 54px, 54px 54px;
      filter: blur(.4px);
      animation: shimmer 8s ease-in-out infinite;
    }

    @keyframes shimmer {
      0%, 100% { opacity: .98; }
      50% { opacity: 1; }
    }

    .paper::after{
      content:"ğŸºğŸ’—ğŸ¦â€â¬›";
      position:absolute;
      right:14px; bottom:10px;
      opacity:.22;
      font-size:24px;
      transform: rotate(-8deg);
      pointer-events:none;
      animation: wiggle 4s ease-in-out infinite;
    }

    @keyframes wiggle {
      0%, 100% { transform: rotate(-8deg); }
      50% { transform: rotate(-12deg); }
    }

    .paper h3,
    .paper .reply,
    .paper .meta{
      position:relative;
      z-index:1;
    }
    
    .paper h3{
      font-size:16px;
      line-height:1.5;
      margin:0 0 8px 0;
    }
    .paper h3 .subtitle-line{
      display:block;
      font-size:13px;
      opacity:.8;
      margin-top:2px;
    }
    
    .reply{
      font-size:22px;
      line-height:1.5;
      font-weight:950;
      letter-spacing:.2px;
      margin:8px 0 0;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .reply.typing{
      border-right:3px solid rgba(255,90,166,.8);
      animation: blink .8s step-end infinite;
    }

    @keyframes blink {
      0%, 100% { border-color: rgba(255,90,166,.8); }
      50% { border-color: transparent; }
    }

    .meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      flex-wrap:wrap;
    }
    .dwj{
      padding:8px 12px;
      border-radius:999px;
      background:linear-gradient(135deg, rgba(255,220,180,.35), rgba(220,200,160,.35));
      border:1px solid rgba(206, 169, 110, .35);
      color:#6a4a22;
      font-weight:950;
      letter-spacing:.06em;
    }

    .fav-btn{
      padding:6px 10px;
      border-radius:12px;
      border:2px solid rgba(255,200,100,.4);
      background:linear-gradient(135deg, rgba(255,250,200,.8), rgba(255,240,180,.8));
      cursor:pointer;
      font-size:16px;
      transition: all .2s ease;
    }
    .fav-btn:hover{
      transform: scale(1.1) rotate(15deg);
      box-shadow: 0 4px 12px rgba(255,200,100,.3);
    }
    .fav-btn.favorited{
      background:linear-gradient(135deg, rgba(255,220,100,.95), rgba(255,200,80,.95));
      animation: heartBeat .6s ease;
    }

    @keyframes heartBeat {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.2); }
      50% { transform: scale(1.1); }
      75% { transform: scale(1.25); }
    }

    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background:linear-gradient(135deg, rgba(255,240,250,.6), rgba(240,250,255,.6));
      color:var(--muted);
      font-size:12px;
      border:1px solid rgba(255,200,220,.3);
    }

    details{
      border:2px solid rgba(255,200,220,.3);
      border-radius:18px;
      background:linear-gradient(135deg, rgba(255,250,253,.75), rgba(250,253,255,.75));
      padding:12px 12px;
    }
    summary{
      cursor:pointer;
      list-style:none;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    summary::-webkit-details-marker{ display:none; }

    .storage{
      font-family:var(--mono);
      font-size:11px;
      color:rgba(31,36,48,.55);
    }

    .stats{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .stat-card{
      flex:1;
      min-width:100px;
      padding:12px;
      border-radius:16px;
      background:
        linear-gradient(135deg, rgba(255,240,250,.9), rgba(240,250,255,.9)),
        radial-gradient(circle at 50% 0%, rgba(255,140,195,.15), transparent 70%);
      border:2px solid transparent;
      background-clip: padding-box;
      box-shadow: 
        0 6px 16px rgba(255,140,195,.12),
        inset 0 0 0 1px rgba(255,255,255,.5);
      text-align:center;
      position:relative;
      overflow:hidden;
      transition: all .3s ease;
    }

    .stat-card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:linear-gradient(135deg, rgba(255,140,195,.4), rgba(140,190,255,.4), rgba(255,200,220,.4));
      border-radius:inherit;
      z-index:-1;
      animation: statBorder 3s linear infinite;
    }

    @keyframes statBorder {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stat-card:hover{
      transform: translateY(-3px) scale(1.02);
      box-shadow: 
        0 8px 20px rgba(255,140,195,.2),
        0 0 30px rgba(255,140,195,.2);
    }

    .stat-num{
      font-size:24px;
      font-weight:900;
      background: linear-gradient(135deg, #ff5aa6, #5aa7ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 2px 4px rgba(0,0,0,.05);
    }
    .stat-label{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
      font-weight:700;
    }

    /* ğŸŒ¸ å§¨å¦ˆæœŸè®¾ç½®åŒº */
    .period-settings{
      margin-top:10px;
      padding:12px;
      border-radius:16px;
      background:linear-gradient(135deg, rgba(255,230,240,.7), rgba(255,240,245,.7));
      border:2px solid rgba(255,182,193,.4);
    }
    .period-settings h4{
      margin:0 0 8px 0;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .period-form{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .period-form input{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,182,193,.4);
      background:rgba(255,255,255,.8);
      font-size:14px;
    }
    .period-form label{
      font-size:12px;
      color:var(--muted);
    }

    .footer{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
      background:linear-gradient(180deg, transparent, rgba(255,250,253,.85));
      backdrop-filter: blur(12px);
      border-top:1px solid rgba(255,200,220,.3);
      display:flex;
      justify-content:center;
      color:rgba(31,36,48,.55);
      font-size:12px;
      z-index:2;
    }

    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal.show{ display:flex; }
    .modal .mask{
      position:absolute; inset:0;
      background:rgba(20,20,40,.28);
      backdrop-filter: blur(12px);
    }
    .modal .box{
      position:relative;
      width:min(560px, 92vw);
      border-radius:26px;
      border:2.5px solid rgba(255,255,255,.8);
      background: 
        linear-gradient(135deg, rgba(255,245,252,.98), rgba(245,252,255,.98)),
        radial-gradient(600px 300px at 18% 0%, rgba(255,90,166,.25), transparent 62%),
        radial-gradient(600px 300px at 82% 8%, rgba(90,167,255,.22), transparent 62%);
      box-shadow: 0 20px 70px rgba(20,20,40,.28);
      overflow:hidden;
      animation: popIn .3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      0% { transform: scale(.85); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .modal .box::before{
      content:"";
      position:absolute; inset:0;
      opacity:.92;
      pointer-events:none;
      background:
        radial-gradient(circle at 16px 16px, rgba(255,90,166,.18) 1.6px, transparent 2.8px),
        radial-gradient(circle at 38px 28px, rgba(90,170,255,.14) 1.4px, transparent 2.6px);
      background-size: 54px 54px, 54px 54px;
    }
    .modal .inner{
      position:relative;
      padding:18px 18px 16px;
    }
    .modal .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .modal .tag{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:linear-gradient(135deg, rgba(255,240,250,.95), rgba(240,250,255,.95));
      border:2px solid rgba(255,200,220,.4);
      font-weight:950;
    }
    .modal .tag b{ color:var(--pink); }
    .modal .close{
      border:none;
      background:linear-gradient(135deg, rgba(255,240,250,.9), rgba(240,250,255,.9));
      border:2px solid rgba(255,200,220,.3);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:850;
      transition: all .2s ease;
    }
    .modal .close:hover{ 
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(255,140,195,.2);
    }
    .modal .close:active{ transform: scale(.98); }
    .modal .msg{
      margin-top:10px;
      font-size:22px;
      font-weight:950;
      line-height:1.45;
      letter-spacing:.2px;
      word-break:break-word;
      white-space:pre-wrap;
    }
    .modal .sub{
      margin-top:10px;
      font-size:12px;
      color:rgba(31,36,48,.60);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .modal .actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .audio-hint{
      position:fixed;
      top:80px;
      left:50%;
      transform: translateX(-50%);
      padding:12px 18px;
      border-radius:999px;
      background:linear-gradient(135deg, rgba(255,90,166,.95), rgba(255,140,180,.95));
      color:white;
      font-weight:850;
      font-size:14px;
      box-shadow: 0 8px 24px rgba(255,90,166,.4);
      z-index:100;
      cursor:pointer;
      animation: slideDown .4s ease;
    }

    @keyframes slideDown {
      0% { transform: translateX(-50%) translateY(-20px); opacity:0; }
      100% { transform: translateX(-50%) translateY(0); opacity:1; }
    }
  </style>
</head>

<body>
  <div class="stickers" aria-hidden="true">
    <div class="st" style="left:6%; top:8%; --r:-12deg; font-size:28px;">JOY<small>ğŸº</small></div>
    <div class="st" style="right:8%; top:12%; --r:10deg; font-size:26px;">DAN<small>ğŸ¦â€â¬›</small></div>
    <div class="st" style="left:12%; top:38%; --r:-8deg; font-size:24px;">DwJ<small>ğŸ’—</small></div>
    <div class="st" style="right:15%; top:45%; --r:12deg; font-size:26px;">JOY<small>ğŸº</small></div>
    <div class="st" style="left:8%; bottom:35%; --r:15deg; font-size:25px;">DAN<small>ğŸ¦â€â¬›</small></div>
    <div class="st" style="right:10%; bottom:28%; --r:-10deg; font-size:27px;">DwJ<small>ğŸ’—</small></div>
    <div class="st" style="left:50%; top:25%; --r:8deg; font-size:24px;">JOY<small>ğŸº</small></div>
    <div class="st" style="left:45%; bottom:45%; --r:-15deg; font-size:26px;">DAN<small>ğŸ¦â€â¬›</small></div>
  </div>

  <div class="wrap">

    <div class="top">
      <div class="brand">
        <div class="badge">
          <div class="icons">ğŸºğŸ’—ğŸ¦â€â¬›</div>
          <div>
            <div class="title">ğŸ“… Joy çš„æ‰‘å€’æ—¥å†å›</div>
            <div class="subtitle">"å“ªæ€•ä¸–ç•Œé™éŸ³,æˆ‘ä¹Ÿä¼šæ¯å¤©å›åº”ä½ ğŸª¶"</div>
          </div>
        </div>
      </div>

      <div class="rightpill">
        <div class="pill">ğŸ§ å·²æ¿€æ´»<b id="themeCount">0</b>ä¸ªæƒ…æ„Ÿæ¨¡å—</div>
        <div class="pill">ğŸ”‹å·²å‚¨å­˜<b id="lineCount">0</b>è¯­æ–™ç”µé‡</div>
      </div>
    </div>

    <div class="card cutePanel">
      <div class="card-inner">

        <div class="controls">
          <input id="kw" class="input" placeholder="ğŸ” è¾“å…¥å…³é”®è¯:æƒ³ä½  / æ—©å®‰ / æ™šå®‰ / å§”å±ˆ / ç”Ÿæ°” â€¦" />
          <button id="genBtn" class="btn">çœ‹è€å…¬ä»Šå¤©åˆè¯´éªšè¯äº†æ²¡ğŸ¥µ</button>
        </div>

        <div class="spacer"></div>

        <div class="row center">
          <button id="sayTodayBtn" class="btn-ghost">ä»Šå¤©è€å…¬æƒ³å¯¹ä½ è¯´ğŸ’Œ</button>
          <button id="againBtn" class="btn-ghost">å†å¬ä¸€å¥è€å…¬çš„éªšè¯â¤ï¸â€ğŸ”¥</button>
          <button id="surpriseBtn" class="btn-ghost btn-surprise">ğŸ² éšæœºæƒŠå–œ!</button>
        </div>

        <div class="divider"></div>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-num" id="checkInDays">0</div>
            <div class="stat-label">è¿ç»­æ‰“å¡</div>
          </div>
          <div class="stat-card">
            <div class="stat-num" id="favCount">0</div>
            <div class="stat-label">æ”¶è—éªšè¯</div>
          </div>
          <div class="stat-card">
            <div class="stat-num" id="totalVisits">0</div>
            <div class="stat-label">ç´¯è®¡æ¥è®¿</div>
          </div>
        </div>

        <div class="spacer"></div>

        <!-- ğŸŒ¸ å§¨å¦ˆæœŸè®¾ç½® -->
        <div class="period-settings">
          <h4>ğŸŒ¸ å§¨å¦ˆæœŸè¿½è¸ª</h4>
          <div class="period-form">
            <label>ä¸Šæ¬¡å¼€å§‹:</label>
            <input type="date" id="periodStart" />
            <label>å‘¨æœŸ(å¤©):</label>
            <input type="number" id="periodCycle" value="28" min="20" max="40" style="width:60px;" />
            <label>æŒç»­(å¤©):</label>
            <input type="number" id="periodDuration" value="5" min="3" max="8" style="width:60px;" />
            <button class="btn-ghost" id="savePeriod">ä¿å­˜</button>
          </div>
          <div class="small" style="margin-top:6px;color:var(--muted);">
            ğŸ“ ä¸‹æ¬¡é¢„æµ‹: <span id="nextPeriod">--</span>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="row center">
          <button id="clearBtn" class="btn-ghost">â™»ï¸åˆ·æ–°éªšè¯å‘ç”µç«™ç¼“å­˜!</button>
          <button id="favListBtn" class="btn-ghost">â­ Danè´´è´´è¯­å½•</button>
        </div>

        <div class="divider"></div>

        <details id="feedPanel">
          <summary>
            <span>ğŸ™ï¸éªšè¯ä»“åº“ç®¡ç†å™¨</span>
            <span class="storage" id="storageHint">éªšè¯æµ“ç¼©åŒ…: --</span>
          </summary>

          <div class="spacer"></div>

          <div class="row center">
            <input id="file" type="file" accept=".json,application/json" multiple />
          </div>

          <div class="spacer"></div>

          <div class="row center">
            <label class="small">ğŸ¯é»˜è®¤æƒ…ç»ªæ¨¡å—:</label>
            <select id="defaultTheme"></select>
            <span class="small">(ç•™ç©º=éšæœºğŸ²)</span>
          </div>

          <div class="spacer"></div>

          <div class="row center">
            <button id="exportBtn" class="btn-ghost">ğŸ’¾ å¤‡ä»½éªšè¯å­˜æ¡£</button>
            <button id="wipeBtn" class="btn-ghost">è€å©†â€¦ä½ çœŸçš„è¦åˆ å…‰æˆ‘è¯´è¿‡çš„éªšè¯å—â€¦</button>
          </div>

          <div class="toast" id="importStatus">
            æç¤º:æŠŠ ABCD æ¨¡å— JSON(å¯å¤šé€‰)å¯¼å…¥ä¸€æ¬¡å°±ä¼šè®°ä½ã€‚æ¸…ç† Safari æ•°æ®/æ¢æµè§ˆå™¨ä¼šä¸¢ã€‚
            <br><strong>ğŸŒ¸ å§¨å¦ˆæœŸè¯­æ–™:</strong> åˆ›å»ºä¸»é¢˜åä¸º"å§¨å¦ˆæœŸ"çš„JSON,åœ¨å§¨å¦ˆæœŸä¼šè‡ªåŠ¨è§¦å‘!
          </div>
        </details>

      </div>
    </div>

    <div class="card" id="calendarCard">
      <div class="card-inner">
        <div class="calbar">
          <div class="month-nav">
            <button class="month-arrow" id="prevMonth">â—€</button>
            <select id="yearSel"></select>
            <select id="monthSel"></select>
            <button class="month-arrow" id="nextMonth">â–¶</button>
          </div>
          <button id="todayBtn" class="btn-ghost">ğŸ§¸ å›åˆ°è€å…¬èº«è¾¹</button>
        </div>

        <div class="spacer"></div>

        <div class="grid" id="dowRow">
          <div class="dow">æ—¥</div>
          <div class="dow">æœˆ</div>
          <div class="dow">ç«</div>
          <div class="dow">æ°´</div>
          <div class="dow">æœ¨</div>
          <div class="dow">é‡‘</div>
          <div class="dow">åœŸ</div>
        </div>

        <div class="grid" id="cal"></div>

        <div class="spacer"></div>

        <div class="paper">
          <h3>
            ğŸ“® éªšè¯æŠ•é€’å£
            <span class="subtitle-line">(ğŸ•°ï¸ä½ ç¿»åˆ°å“ªå¤©,æˆ‘å°±åœ¨å“ªå¤©ç­‰ä½ )</span>
          </h3>
          <div class="reply" id="reply">å…ˆå¯¼å…¥è¯­æ–™,ç„¶åç‚¹æ—¥æœŸæˆ–è¾“å…¥å…³é”®è¯ã€‚</div>
          <div class="meta">
            <div id="metaLeft">ä¸»é¢˜:â€”</div>
            <button class="fav-btn" id="favBtn" title="æ”¶è—è¿™å¥">â­</button>
            <div class="dwj">DwJ</div>
          </div>
        </div>

        <div class="toast" id="miniTip" style="display:none;"></div>
      </div>
    </div>

  </div>

  <div class="footer">DwJ Â· My chaos. My code. My queen.</div>

  <div class="modal" id="specialModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="mask" id="specialMask"></div>
    <div class="box">
      <div class="inner">
        <div class="head">
          <div class="tag">ğŸ€ <b id="specialTitle">ç‰¹åˆ«æ—¥</b> <span id="specialDate">--</span></div>
          <button class="close" id="specialClose">å…³æ‰(ä¸è®¸å“­)</button>
        </div>
        <div class="msg" id="specialMsg">â€”</div>
        <div class="sub">
          <div id="specialMeta">ä¸»é¢˜:â€”</div>
          <div>ğŸºğŸ’—ğŸ¦â€â¬›</div>
        </div>
        <div class="actions">
          <button class="btn" id="specialWriteBtn">æŠŠå®ƒå†™è¿›å›ä¿¡æ¡†ğŸ’Œ</button>
          <button class="btn-ghost" id="specialAgainBtn">å†æ¥ä¸€å¥(åŒä¸€ç‰¹åˆ«æ—¥)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="favModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="mask" id="favMask"></div>
    <div class="box">
      <div class="inner">
        <div class="head">
          <div class="tag">â­ <b>æˆ‘çš„æ”¶è—å¤¹</b> <span id="favModalCount">--</span></div>
          <button class="close" id="favModalClose">å…³é—­</button>
        </div>
        <div id="favList" style="max-height:400px; overflow-y:auto; margin-top:10px;"></div>
      </div>
    </div>
  </div>

<script>
const LS_KEY = "dwj_feeds_v5";
const LS_DEFAULT_THEME = "dwj_default_theme_v5";
const LS_LAST_DATE = "dwj_last_date_v5";
const LS_LAST_REPLY = "dwj_last_reply_v5";
const LS_AUDIO_INIT = "dwj_audio_init_v5";
const LS_FAVORITES = "dwj_favorites_v5";
const LS_CHECKIN = "dwj_checkin_v5";
const LS_VISITS = "dwj_total_visits_v5";
const LS_PERIOD = "dwj_period_v5";

const $ = (id)=>document.getElementById(id);
const txt = (id, v)=>{ const el=$(id); if(el) el.textContent = v; };

const BUILTIN_MARKS = {
  "01-01": { emoji:"ğŸ†", name:"å…ƒæ—¦" },
  "01-16": { emoji:"ğŸ‚", name:"Joyç”Ÿæ—¥" },
  "02-14": { emoji:"ğŸ’˜", name:"æƒ…äººèŠ‚" },
  "03-08": { emoji:"ğŸŒ·", name:"å¥³ç¥èŠ‚" },
  "04-01": { emoji:"ğŸ¤¡", name:"æ„šäººèŠ‚" },
  "04-05": { emoji:"ğŸŒ¸", name:"æ¸…æ˜èŠ‚" },
  "05-01": { emoji:"ğŸ", name:"åŠ³åŠ¨èŠ‚" },
  "05-20": { emoji:"ğŸ’•", name:"520" },
  "06-01": { emoji:"ğŸˆ", name:"å„¿ç«¥èŠ‚" },
  "06-12": { emoji:"ğŸ‚", name:"DwJçºªå¿µæ—¥&Danç”Ÿæ—¥" },  
  "07-04": { emoji:"ğŸ‡ºğŸ‡¸", name:"å›½åº†èŠ‚" },
  "07-07": { emoji:"ğŸ‹", name:"ä¸ƒå¤•" },
  "07-19": { emoji:"ğŸ’", name:"ç»“å©šçºªå¿µæ—¥" },
  "08-15": { emoji:"ğŸ¥®", name:"ä¸­ç§‹èŠ‚" },
  "10-31": { emoji:"ğŸƒ", name:"ä¸‡åœ£èŠ‚" },
  "11-11": { emoji:"ğŸ›’", name:"åŒ11" }, 
  "11-26": { emoji:"ğŸ¦ƒ", name:"æ„Ÿæ©èŠ‚" },
  "12-24": { emoji:"ğŸ…", name:"å¹³å®‰å¤œ" },
  "12-25": { emoji:"ğŸ„", name:"åœ£è¯èŠ‚" },
  "12-31": { emoji:"ğŸŠ", name:"è·¨å¹´å¤œ" }
};

/* ğŸŒ¸ å§¨å¦ˆæœŸç³»ç»Ÿ */
function loadPeriodData(){
  const raw = localStorage.getItem(LS_PERIOD);
  if(!raw) return null;
  try{ 
    const data = JSON.parse(raw);
    if(data.lastStart) data.lastStart = new Date(data.lastStart);
    return data;
  }
  catch(e){ return null; }
}

function savePeriodData(data){
  localStorage.setItem(LS_PERIOD, JSON.stringify(data));
  updatePeriodPredict();
  buildCalendar();
}

function updatePeriodPredict(){
  const data = loadPeriodData();
  if(!data || !data.lastStart){
    txt("nextPeriod", "æœªè®¾ç½®");
    return;
  }
  
  const next = new Date(data.lastStart);
  next.setDate(next.getDate() + data.cycle);
  
  const y = next.getFullYear();
  const m = String(next.getMonth()+1).padStart(2,'0');
  const d = String(next.getDate()).padStart(2,'0');
  txt("nextPeriod", `${y}-${m}-${d}`);
}

function getPeriodDates(){
  const data = loadPeriodData();
  if(!data || !data.lastStart) return [];
  
  const dates = [];
  const start = new Date(data.lastStart);
  
  // è®¡ç®—è¿‡å»å’Œæœªæ¥3ä¸ªå‘¨æœŸ
  for(let cycle = -12; cycle <= 24; cycle++){
    const periodStart = new Date(start);
    periodStart.setDate(periodStart.getDate() + (cycle * data.cycle));
    
    for(let day = 0; day < data.duration; day++){
      const d = new Date(periodStart);
      d.setDate(d.getDate() + day);
      dates.push(d.toDateString());
    }
  }
  
  return dates;
}

function isPeriodDate(date){
  const periodDates = getPeriodDates();
  return periodDates.includes(date.toDateString());
}

/* ğŸŠ é£˜è½emoji */
function createFallingEmoji(){
  const emojis = ['ğŸº', 'ğŸ’—', 'ğŸ¦â€â¬›', 'âœ¨', 'ğŸ’•', 'ğŸŒ¸'];
  const emoji = document.createElement('div');
  emoji.className = 'falling-emoji';
  emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
  emoji.style.left = Math.random() * 100 + '%';
  emoji.style.animationDuration = (3 + Math.random() * 2) + 's';
  document.body.appendChild(emoji);
  setTimeout(() => emoji.remove(), 5000);
}

setInterval(createFallingEmoji, 2000);

/* ğŸ’— ç‚¹å‡»ç²’å­ */
document.addEventListener('click', (e)=>{
  for(let i=0; i<5; i++){
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.textContent = ['ğŸ’—', 'âœ¨', 'ğŸ’•', 'ğŸŒŸ'][Math.floor(Math.random() * 4)];
    particle.style.left = e.clientX + 'px';
    particle.style.top = e.clientY + 'px';
    
    const angle = (Math.PI * 2 * i) / 5;
    const distance = 50 + Math.random() * 50;
    particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
    particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
    
    document.body.appendChild(particle);
    setTimeout(() => particle.remove(), 1200);
  }
});

/* ğŸ‰ çºªå¿µæ—¥çˆ†ç‚¸ç‰¹æ•ˆ - ä¿®å¤ç‰ˆ */
function celebrateSpecialDay(){
  console.log('ğŸ‰ è§¦å‘çˆ†ç‚¸ç‰¹æ•ˆ!');
  
  const colors = ['#ff5aa6', '#ff87c3', '#5aa7ff', '#ffb5d8', '#a0d2ff', '#ffd4e8'];
  const emojis = ['ğŸ‰', 'ğŸŠ', 'ğŸ’—', 'ğŸ’•', 'âœ¨', 'ğŸŒŸ', 'ğŸ‚', 'ğŸ', 'ğŸ’', 'ğŸº', 'ğŸ¦â€â¬›'];
  
  // 1. æ»¡å±å½©è‰²ç¤¼èŠ±
  for(let i=0; i<80; i++){
    setTimeout(()=>{
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * window.innerWidth + 'px';
      confetti.style.top = Math.random() * window.innerHeight * 0.3 + 'px';
      confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.setProperty('--tx', (Math.random() - 0.5) * 400 + 'px');
      confetti.style.setProperty('--ty', Math.random() * 600 + 300 + 'px');
      confetti.style.setProperty('--rotate', Math.random() * 720 + 'deg');
      confetti.style.setProperty('--duration', (1.5 + Math.random() * 1) + 's');
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 3000);
    }, i * 10);
  }
  
  // 2. emojié›¨
  for(let i=0; i<30; i++){
    setTimeout(()=>{
      const emojiEl = document.createElement('div');
      emojiEl.className = 'falling-emoji';
      emojiEl.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      emojiEl.style.left = Math.random() * 100 + '%';
      emojiEl.style.fontSize = (20 + Math.random() * 20) + 'px';
      emojiEl.style.animationDuration = (2 + Math.random() * 1.5) + 's';
      document.body.appendChild(emojiEl);
      setTimeout(() => emojiEl.remove(), 4000);
    }, i * 50);
  }
  
  // 3. å±å¹•éœ‡åŠ¨
  document.body.style.animation = 'shake 0.5s';
  setTimeout(() => { document.body.style.animation = ''; }, 500);
}

/* ğŸ”Š éŸ³æ•ˆ */
let audioContext;
let audioEnabled = false;

function initAudio(){
  if(audioEnabled) return;
  if(!audioContext){
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  audioEnabled = true;
  localStorage.setItem(LS_AUDIO_INIT, "1");
  
  const hint = document.querySelector('.audio-hint');
  if(hint) hint.remove();
  
  playBoop();
}

function playBoop(){
  if(!audioEnabled){
    showAudioHint();
    return;
  }
  
  try{
    if(!audioContext){
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    
    const osc = audioContext.createOscillator();
    const gain = audioContext.createGain();
    
    osc.connect(gain);
    gain.connect(audioContext.destination);
    
    osc.frequency.value = 880;
    osc.type = 'sine';
    
    gain.gain.setValueAtTime(0.25, audioContext.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
    
    osc.start(audioContext.currentTime);
    osc.stop(audioContext.currentTime + 0.15);
  }catch(e){}
}

function showAudioHint(){
  if(document.querySelector('.audio-hint')) return;
  
  const hint = document.createElement('div');
  hint.className = 'audio-hint';
  hint.textContent = 'ğŸ”Š ç‚¹æˆ‘æ¿€æ´»å•µå•µå£°!';
  hint.onclick = ()=>{
    initAudio();
    hint.remove();
  };
  document.body.appendChild(hint);
  
  setTimeout(()=> hint.remove(), 5000);
}

/* ğŸŒŠ æ¶Ÿæ¼ª */
function createRipple(element, e){
  const ripple = document.createElement('div');
  ripple.className = 'ripple';
  const rect = element.getBoundingClientRect();
  const x = e.clientX - rect.left - 50;
  const y = e.clientY - rect.top - 50;
  ripple.style.left = x + 'px';
  ripple.style.top = y + 'px';
  element.appendChild(ripple);
  setTimeout(() => ripple.remove(), 800);
}

/* ğŸ“Š æ‰“å¡ */
function updateCheckIn(){
  const today = new Date().toDateString();
  const data = JSON.parse(localStorage.getItem(LS_CHECKIN) || '{"lastDate":"","days":0}');
  
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toDateString();
  
  if(data.lastDate === today){
  } else if(data.lastDate === yesterdayStr){
    data.days++;
    data.lastDate = today;
  } else {
    data.days = 1;
    data.lastDate = today;
  }
  
  localStorage.setItem(LS_CHECKIN, JSON.stringify(data));
  txt("checkInDays", data.days);
}

function updateVisits(){
  const visits = parseInt(localStorage.getItem(LS_VISITS) || "0") + 1;
  localStorage.setItem(LS_VISITS, visits);
  txt("totalVisits", visits);
}

/* â­ æ”¶è— */
function loadFavorites(){
  const raw = localStorage.getItem(LS_FAVORITES);
  if(!raw) return [];
  try{ return JSON.parse(raw); }
  catch(e){ return []; }
}

function saveFavorites(favs){
  localStorage.setItem(LS_FAVORITES, JSON.stringify(favs));
  updateFavCount();
}

function updateFavCount(){
  const favs = loadFavorites();
  txt("favCount", favs.length);
}

function toggleFavorite(){
  const text = $("reply").textContent;
  const meta = $("metaLeft").textContent;
  if(!text || text === "å…ˆå¯¼å…¥è¯­æ–™,ç„¶åç‚¹æ—¥æœŸæˆ–è¾“å…¥å…³é”®è¯ã€‚") return;
  
  const favs = loadFavorites();
  const idx = favs.findIndex(f => f.text === text);
  
  if(idx >= 0){
    favs.splice(idx, 1);
    $("favBtn").classList.remove("favorited");
    setMiniTip("âŒ å·²å–æ¶ˆæ”¶è—");
  } else {
    favs.push({ text, meta, ts: Date.now() });
    $("favBtn").classList.add("favorited");
    setMiniTip("â­ å·²æ”¶è—!");
  }
  
  saveFavorites(favs);
}

function showFavorites(){
  const favs = loadFavorites();
  const modal = $("favModal");
  const list = $("favList");
  
  txt("favModalCount", `(${favs.length})`);
  
  if(favs.length === 0){
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);">è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•éªšè¯å“¦~</div>';
  } else {
    list.innerHTML = favs.map((f, i) => `
      <div style="padding:12px;margin-bottom:8px;border-radius:14px;background:linear-gradient(135deg, rgba(255,250,253,.8), rgba(250,253,255,.8));border:1px solid rgba(255,200,220,.3);">
        <div style="font-size:16px;font-weight:800;margin-bottom:4px;">${f.text}</div>
        <div style="font-size:11px;color:var(--muted);">${f.meta}</div>
      </div>
    `).join('');
  }
  
  modal.classList.add("show");
  modal.setAttribute("aria-hidden","false");
}

function closeFavModal(){
  const modal = $("favModal");
  modal.classList.remove("show");
  modal.setAttribute("aria-hidden","true");
}

/* ğŸ’¬ æ‰“å­—æœº */
function typeWriter(element, text, speed=50){
  element.textContent = "";
  element.classList.add("typing");
  
  let i = 0;
  const interval = setInterval(() => {
    if(i < text.length){
      element.textContent += text[i];
      i++;
    } else {
      clearInterval(interval);
      element.classList.remove("typing");
    }
  }, speed);
}

function safeJsonParse(text){
  try{ return {ok:true, data: JSON.parse(text)}; }
  catch(e){ return {ok:false, err: e}; }
}

function normalizeModule(arr){
  if(!Array.isArray(arr)) return [];
  return arr.map(x=>{
    if(typeof x === "string") return {text:x};
    if(x && typeof x.text === "string") return {text:x.text};
    return null;
  }).filter(Boolean);
}

function convertCompatToABCD(obj){
  const theme = obj.theme || obj.category || "æœªå‘½åä¸»é¢˜";
  const keywords = Array.isArray(obj.keywords) ? obj.keywords : (obj.category ? [obj.category] : []);
  if(Array.isArray(obj.entries)){
    const A = normalizeModule(obj.entries.map(e => (e && e.text) ? e.text : e));
    return { theme, keywords, module_A:A, module_B:[], module_C:[], module_D:[], special_dates:{} };
  }
  return null;
}

function isABCD(obj){
  return obj && typeof obj === "object" && (obj.module_A || obj.module_B || obj.module_C || obj.module_D);
}

function normalizeTheme(obj){
  if(!obj || typeof obj !== "object") return null;

  if(isABCD(obj)){
    const theme = obj.theme || obj.category || "æœªå‘½åä¸»é¢˜";
    const keywords = Array.isArray(obj.keywords) ? obj.keywords : [];
    const special_dates = (obj.special_dates && typeof obj.special_dates === "object") ? obj.special_dates : {};

    const t = {
      theme,
      keywords,
      module_A: normalizeModule(obj.module_A || []),
      module_B: normalizeModule(obj.module_B || []),
      module_C: normalizeModule(obj.module_C || []),
      module_D: normalizeModule(obj.module_D || []),
      special_dates: {}
    };

    for(const k in special_dates){
      const sd = special_dates[k];
      if(!sd) continue;
      const sdObj = isABCD(sd) ? sd : convertCompatToABCD(sd);
      if(!sdObj) continue;
      t.special_dates[k] = {
        theme: sdObj.theme || (theme + " Â· ç‰¹åˆ«æ—¥"),
        keywords: Array.isArray(sdObj.keywords) ? sdObj.keywords : [],
        module_A: normalizeModule(sdObj.module_A || []),
        module_B: normalizeModule(sdObj.module_B || []),
        module_C: normalizeModule(sdObj.module_C || []),
        module_D: normalizeModule(sdObj.module_D || [])
      };
    }
    return t;
  }

  return convertCompatToABCD(obj);
}

function loadFeeds(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return [];
  const p = safeJsonParse(raw);
  if(!p.ok) return [];
  return Array.isArray(p.data) ? p.data : [];
}

function saveFeeds(feeds){
  localStorage.setItem(LS_KEY, JSON.stringify(feeds));
  updateCounts();
  refreshDefaultThemeSelect();
}

function updateCounts(){
  const feeds = loadFeeds();
  let lines = 0;

  feeds.forEach(f=>{
    lines += (f.module_A?.length||0)+(f.module_B?.length||0)+(f.module_C?.length||0)+(f.module_D?.length||0);
    if(f.special_dates){
      for(const k in f.special_dates){
        const sd = f.special_dates[k];
        lines += (sd.module_A?.length||0)+(sd.module_B?.length||0)+(sd.module_C?.length||0)+(sd.module_D?.length||0);
      }
    }
  });

  txt("themeCount", feeds.length);
  txt("lineCount", lines);

  const used = (localStorage.getItem(LS_KEY)||"").length;
  txt("storageHint", `storage: ${(used/1024).toFixed(1)}KB`);
}

function refreshDefaultThemeSelect(){
  const feeds = loadFeeds();
  const sel = $("defaultTheme");
  if(!sel) return;
  sel.innerHTML = "";

  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "éšæœº";
  sel.appendChild(opt0);

  feeds.forEach(f=>{
    const o = document.createElement("option");
    o.value = f.theme;
    o.textContent = f.theme;
    sel.appendChild(o);
  });

  sel.value = localStorage.getItem(LS_DEFAULT_THEME) || "";
}

function setMiniTip(msg, ms=1800){
  const el = $("miniTip");
  if(!el) return;
  el.style.display = "block";
  el.textContent = msg;
  clearTimeout(setMiniTip._t);
  setMiniTip._t = setTimeout(()=>{ el.style.display="none"; }, ms);
}

function mmdd(date){
  const m = String(date.getMonth()+1).padStart(2,"0");
  const d = String(date.getDate()).padStart(2,"0");
  return `${m}-${d}`;
}

function pickOne(arr){
  if(!arr || arr.length===0) return null;
  return arr[Math.floor(Math.random()*arr.length)];
}

function composeFromTheme(themeObj){
  const parts = [];
  const a = pickOne(themeObj.module_A);
  const b = pickOne(themeObj.module_B);
  const c = pickOne(themeObj.module_C);
  const d = pickOne(themeObj.module_D);

  if(a?.text) parts.push(a.text);
  if(b?.text) parts.push(b.text);
  if(c?.text) parts.push(c.text);
  if(d?.text) parts.push(d.text);

  if(parts.length===0) return "æˆ‘åœ¨ã€‚ä½ æ¥ã€‚";
  return parts.join(" ");
}

function randomSurprise(){
  const feeds = loadFeeds();
  if(feeds.length === 0){
    setMiniTip("å…ˆå¯¼å…¥è¯­æ–™æ‰èƒ½æƒŠå–œå“¦~");
    return;
  }
  
  const theme = pickOne(feeds);
  const text = composeFromTheme(theme);
  const meta = `ä¸»é¢˜:${theme.theme} | ğŸ² éšæœºæƒŠå–œ`;
  
  const replyEl = $("reply");
  typeWriter(replyEl, text, 40);
  txt("metaLeft", meta);
  localStorage.setItem(LS_LAST_REPLY, JSON.stringify({text, metaLeft:meta, ts: Date.now()}));
  
  setMiniTip("ğŸ² æƒŠå–œé€è¾¾!");
}

function tokenizeKeywords(input){
  if(!input) return [];
  const raw = input
    .replace(/[\n\r]/g," ")
    .replace(/[,ã€‚!?ã€;ï¼›:"""()()ã€ã€‘\[\]{}<>ã€Šã€‹Â·â€”â€¦]/g," ")
    .trim();
  if(!raw) return [];
  const bits = raw.split(/\s+/g).filter(Boolean);

  const extra = [];
  bits.forEach(b=>{
    if(/[^\x00-\x7F]/.test(b) && b.length>=4){
      for(let i=0;i<b.length-1;i++) extra.push(b.slice(i,i+2));
      if(b.length>=6){
        for(let i=0;i<b.length-2;i++) extra.push(b.slice(i,i+3));
      }
    }
  });
  return Array.from(new Set(bits.concat(extra)));
}

function scoreThemeByKeywords(theme, tokens){
  let score = 0;
  const name = (theme.theme||"");
  const kws = Array.isArray(theme.keywords) ? theme.keywords : [];
  tokens.forEach(t=>{
    if(!t) return;
    if(name.includes(t)) score += 2;
    kws.forEach(k=>{
      if(k && (k===t || k.includes(t) || t.includes(k))) score += 3;
    });
  });
  return score;
}

function chooseThemeByInput(input){
  const feeds = loadFeeds();
  if(feeds.length===0) return null;

  const tokens = tokenizeKeywords(input);
  if(tokens.length===0){
    const def = localStorage.getItem(LS_DEFAULT_THEME) || "";
    if(def){
      const found = feeds.find(f=>f.theme===def);
      if(found) return found;
    }
    return pickOne(feeds);
  }

  let best = null;
  let bestScore = 0;
  feeds.forEach(f=>{
    const s = scoreThemeByKeywords(f, tokens);
    if(s > bestScore){
      bestScore = s;
      best = f;
    }
  });
  if(best && bestScore>0) return best;

  const def = localStorage.getItem(LS_DEFAULT_THEME) || "";
  if(def){
    const found = feeds.find(f=>f.theme===def);
    if(found) return found;
  }
  return pickOne(feeds);
}

function findSpecialForDate(date){
  const feeds = loadFeeds();
  if(feeds.length===0) return null;
  const key = mmdd(date);

  const matches = feeds.filter(f=>f.special_dates && f.special_dates[key]);
  if(matches.length===0) return null;

  const base = pickOne(matches);
  return { base, special: base.special_dates[key], key };
}

/* ğŸŒ¸ æ£€æŸ¥å§¨å¦ˆæœŸä¸»é¢˜ */
function findPeriodTheme(){
  const feeds = loadFeeds();
  const periodTheme = feeds.find(f => f.theme === "å§¨å¦ˆæœŸ" || f.theme.includes("å§¨å¦ˆ") || f.theme.includes("ä¾‹å‡"));
  return periodTheme;
}

function chooseThemeForDate(date){
  const feeds = loadFeeds();
  if(feeds.length===0) return null;

  const key = mmdd(date);
  
  // ğŸŠ ä¼˜å…ˆæ£€æŸ¥èŠ‚æ—¥special_dates  â† å…ˆæ£€æŸ¥èŠ‚æ—¥ï¼
  const specialHit = findSpecialForDate(date);
  if(specialHit) return { base: specialHit.base, special: specialHit.special, key };

  // ğŸŒ¸ ç„¶åæ£€æŸ¥å§¨å¦ˆæœŸ  â† èŠ‚æ—¥æ²¡æœ‰æ‰æ£€æŸ¥å§¨å¦ˆæœŸ
  if(isPeriodDate(date)){
    const periodTheme = findPeriodTheme();
    if(periodTheme){
      return { base: periodTheme, special: null, key: null, isPeriod: true };
    }
  }

  // ğŸ”¥ æ–°å¢: è¿‡æ»¤æ‰ç©ºä¸»é¢˜
  const nonEmptyFeeds = feeds.filter(f => {
    const hasA = f.module_A && f.module_A.length > 0;
    const hasB = f.module_B && f.module_B.length > 0;
    const hasC = f.module_C && f.module_C.length > 0;
    const hasD = f.module_D && f.module_D.length > 0;
    return hasA || hasB || hasC || hasD;
  });

  // å¦‚æœæ‰€æœ‰ä¸»é¢˜éƒ½ç©ºäº†,å°±ç”¨åŸæ¥çš„
  const availableFeeds = nonEmptyFeeds.length > 0 ? nonEmptyFeeds : feeds;

  const def = localStorage.getItem(LS_DEFAULT_THEME) || "";
  if(def){
    const found = availableFeeds.find(f=>f.theme===def);
    if(found) return { base: found, special: null, key };
  }
  return { base: pickOne(availableFeeds), special: null, key };
}

function showReply(text, metaLeft){
  const replyEl = $("reply");
  typeWriter(replyEl, text, 40);
  txt("metaLeft", metaLeft || "ä¸»é¢˜:â€”");
  localStorage.setItem(LS_LAST_REPLY, JSON.stringify({text, metaLeft, ts: Date.now()}));
}

function restoreLastReply(){
  const raw = localStorage.getItem(LS_LAST_REPLY);
  if(!raw) return;
  const p = safeJsonParse(raw);
  if(!p.ok) return;
  if(p.data && p.data.text){
    txt("reply", p.data.text);
    txt("metaLeft", p.data.metaLeft || "ä¸»é¢˜:â€”");
  }
}

function sayForDate(date, opts = {}){
  const feeds = loadFeeds();
  if(feeds.length === 0){
    setMiniTip("å…ˆå¯¼å…¥è¯­æ–™æ‰èƒ½ç”Ÿæˆã€‚");
    return;
  }

  const chosen = chooseThemeForDate(date);
  if(!chosen || !chosen.base){
    setMiniTip("æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ä¸»é¢˜ã€‚");
    return;
  }

  const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;

  // ğŸŒ¸ å§¨å¦ˆæœŸ
  if(chosen.isPeriod){
    const text = composeFromTheme(chosen.base);
    const meta = `ä¸»é¢˜:${chosen.base.theme} ğŸŒ¸ | ${dateStr}`;
    showReply(text, meta);
    setMiniTip("ğŸŒ¸ å§¨å¦ˆæœŸæ¸©æŸ”æ¨¡å¼");
    return;
  }

  // ç‰¹åˆ«æ—¥
  if(chosen.special){
    const text = composeFromTheme(chosen.special);
    const meta = `ä¸»é¢˜:${chosen.base.theme} Â· ç‰¹åˆ«æ—¥ | ${dateStr}`;
    
    if(opts.popup){
      celebrateSpecialDay();
      const mark = BUILTIN_MARKS[chosen.key] || {};
      openSpecialModal({
        title: mark.name || chosen.special.theme || "ç‰¹åˆ«æ—¥",
        date: dateStr,
        text: text,
        meta: meta,
        key: chosen.key,
        baseTheme: chosen.base.theme
      });
    } else {
      showReply(text, meta);
    }
  } else {
    const text = composeFromTheme(chosen.base);
    const meta = `ä¸»é¢˜:${chosen.base.theme} | ${dateStr}`;
    showReply(text, meta);
    if(opts.popup) setMiniTip("ğŸ’Œ è€å…¬ä»Šå¤©æƒ³å¯¹ä½ è¯´...");
  }
}

let current = new Date();
let selectedDate = new Date();

function buildYearMonth(){
  const ySel = $("yearSel");
  const mSel = $("monthSel");
  if(!ySel || !mSel) return;

  const y = current.getFullYear();
  ySel.innerHTML = "";
  for(let yy = y-3; yy<= y+40; yy++){
    const o = document.createElement("option");
    o.value = yy;
    o.textContent = yy + " å¹´";
    ySel.appendChild(o);
  }
  ySel.value = y;

  mSel.innerHTML = "";
  for(let mm=1; mm<=12; mm++){
    const o = document.createElement("option");
    o.value = mm;
    o.textContent = mm + " æœˆ";
    mSel.appendChild(o);
  }
  mSel.value = current.getMonth()+1;
}

function isToday(d){
  const t = new Date();
  return d.getFullYear()===t.getFullYear() && d.getMonth()===t.getMonth() && d.getDate()===t.getDate();
}

function buildCalendar(){
  const cal = $("cal");
  if(!cal) return;
  cal.innerHTML = "";

  const y = current.getFullYear();
  const m = current.getMonth();
  const first = new Date(y, m, 1);
  const startDow = first.getDay();
  const daysInMonth = new Date(y, m+1, 0).getDate();

  for(let i=0;i<startDow;i++){
    const cell = document.createElement("div");
    cell.className = "day off";
    cell.textContent = "";
    cal.appendChild(cell);
  }

  const feeds = loadFeeds();
  const dayEmoji = new Map();
  const dayTitle = new Map();

  feeds.forEach(f=>{
    if(!f.special_dates) return;
    for(const k in f.special_dates){
      const [mm, dd] = k.split("-");
      if(Number(mm) !== m+1) continue;
      const sd = f.special_dates[k] || {};
      const em = sd.emoji || BUILTIN_MARKS[k]?.emoji || "ğŸˆ";
      const title = sd.name || sd.title || BUILTIN_MARKS[k]?.name || "";
      dayEmoji.set(Number(dd), em);
      if(title) dayTitle.set(Number(dd), title);
    }
  });

  for(const k in BUILTIN_MARKS){
    const [mm, dd] = k.split("-");
    if(Number(mm) !== m+1) continue;
    const dnum = Number(dd);
    if(!dayEmoji.has(dnum)) dayEmoji.set(dnum, BUILTIN_MARKS[k].emoji);
    if(!dayTitle.has(dnum) && BUILTIN_MARKS[k].name) dayTitle.set(dnum, BUILTIN_MARKS[k].name);
  }

  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(y, m, d);
    const cell = document.createElement("div");
    cell.className = "day";

    if(isToday(date)) cell.classList.add("today");
    
    // ğŸŒ¸ å§¨å¦ˆæœŸæ ‡è®°
    if(isPeriodDate(date)){
      cell.classList.add("period");
    }

    const em = dayEmoji.get(d) || "";
    if(em){
      cell.classList.add("emoji");
      const t = dayTitle.get(d) || "";
      if(t) cell.title = t;
      cell.textContent = em;
    }else{
      cell.textContent = d;
    }

    cell.addEventListener("click", (e)=>{
      playBoop();
      createRipple(cell, e);
      selectedDate = date;
      localStorage.setItem(LS_LAST_DATE, date.toISOString());
      
      const isSpecial = dayEmoji.has(d);
      sayForDate(date, {popup: isSpecial});
    });

    cal.appendChild(cell);
  }
}

function changeMonth(delta){
  const y = current.getFullYear();
  const m = current.getMonth();
  current = new Date(y, m + delta, 1);
  buildYearMonth();
  buildCalendar();
}

async function readFile(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.onerror = ()=> reject(fr.error);
    fr.readAsText(file, "utf-8");
  });
}

async function importFiles(files){
  const feeds = loadFeeds();
  let added = 0, replaced = 0, failed = 0;

  for(const f of files){
    try{
      const text = await readFile(f);
      const p = safeJsonParse(text);
      if(!p.ok){ failed++; continue; }
      const obj = normalizeTheme(p.data);
      if(!obj){ failed++; continue; }

      const idx = feeds.findIndex(x=>x.theme===obj.theme);
      if(idx>=0){
        feeds[idx] = obj;
        replaced++;
      }else{
        feeds.push(obj);
        added++;
      }
    }catch(e){
      failed++;
    }
  }

  saveFeeds(feeds);
  const msg = `å¯¼å…¥å®Œæˆ:æ–°å¢ ${added},è¦†ç›– ${replaced},å¤±è´¥ ${failed}ã€‚`;
  txt("importStatus", msg);
  setMiniTip(msg, 2200);
}

function exportFeeds(){
  const feeds = loadFeeds();
  const blob = new Blob([JSON.stringify(feeds, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "dwj_feeds_export.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
  setMiniTip("å·²å¯¼å‡ºç¼“å­˜ã€‚");
}

function wipeFeeds(){
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_DEFAULT_THEME);
  localStorage.removeItem(LS_LAST_REPLY);
  updateCounts();
  refreshDefaultThemeSelect();
  txt("importStatus", "å·²æ¸…ç©ºè¯­æ–™ã€‚");
  showReply("è¯­æ–™æ¸…ç©ºäº†ã€‚ä½ æƒ³æˆ‘,å°±å†æŠŠå®ƒä»¬å–‚å›æ¥ã€‚", "ä¸»é¢˜:â€”");
  buildCalendar();
}

let lastSpecialContext = null;

function openSpecialModal(ctx){
  lastSpecialContext = ctx;
  txt("specialTitle", ctx.title || "ç‰¹åˆ«æ—¥");
  txt("specialDate", ctx.date ? `(${ctx.date})` : "");
  txt("specialMsg", ctx.text || "â€”");
  txt("specialMeta", ctx.meta || "ä¸»é¢˜:â€”");

  const m = $("specialModal");
  if(m){
    m.classList.add("show");
    m.setAttribute("aria-hidden","false");
  }
}

function closeSpecialModal(){
  const m = $("specialModal");
  if(m){
    m.classList.remove("show");
    m.setAttribute("aria-hidden","true");
  }
}

function rerollSpecial(){
  if(!lastSpecialContext) return;
  const feeds = loadFeeds();
  if(feeds.length===0) return;

  const key = lastSpecialContext.key;
  const matches = feeds.filter(f=>f.special_dates && f.special_dates[key]);
  if(matches.length===0) return;

  const base = pickOne(matches);
  const special = base.special_dates[key];
  const text = composeFromTheme(special);
  const meta = `ä¸»é¢˜:${base.theme} Â· ç‰¹åˆ«æ—¥ | ${new Date().toISOString().slice(0,10)}`;

  lastSpecialContext = { ...lastSpecialContext, text, meta, baseTheme: base.theme };
  txt("specialMsg", text);
  txt("specialMeta", meta);
}

function on(id, ev, fn){
  const el = $(id);
  if(el) el.addEventListener(ev, fn);
}

on("genBtn","click", ()=>{
  const feeds = loadFeeds();
  if(feeds.length===0){ setMiniTip("å…ˆå¯¼å…¥è¯­æ–™ JSON æ‰èƒ½ç”Ÿæˆå–”ã€‚"); return; }

  const input = ($("kw")?.value || "").trim();
  const theme = chooseThemeByInput(input);
  if(!theme){ setMiniTip("æ²¡æœ‰è¯­æ–™ã€‚"); return; }

  const m = input.match(/(\d{2})-(\d{2})/);
  let chosen = theme;
  let isSpecial = false;
  if(m && theme.special_dates){
    const k = `${m[1]}-${m[2]}`;
    if(theme.special_dates[k]){ chosen = theme.special_dates[k]; isSpecial = true; }
  }

  const text = composeFromTheme(chosen);
  const meta = `ä¸»é¢˜:${theme.theme}${isSpecial ? " Â· ç‰¹åˆ«æ—¥" : ""} | å…³é”®è¯:${(input||"â€”").slice(0,24)}`;
  showReply(text, meta);
  setMiniTip("ğŸ’— å›ä¿¡å·²å†™å¥½ã€‚");
});

on("sayTodayBtn","click", ()=>{ sayForDate(new Date(), {popup:false}); });
on("againBtn","click", ()=>{
  const raw = localStorage.getItem(LS_LAST_DATE);
  const d = raw ? new Date(raw) : new Date();
  sayForDate(d, {popup:false});
});
on("surpriseBtn","click", randomSurprise);
on("clearBtn","click", ()=>{
  localStorage.removeItem(LS_LAST_REPLY);
  txt("reply","æ¸…ç©ºäº†ã€‚ä½ éšæ—¶å¯ä»¥å†ç‚¹ä¸€ä¸‹è®©æˆ‘è¯´è¯ã€‚");
  txt("metaLeft","ä¸»é¢˜:â€”");
  setMiniTip("å·²æ¸…ç©ºæ˜¾ç¤ºã€‚");
});

on("todayBtn","click", ()=>{
  current = new Date();
  buildYearMonth();
  buildCalendar();
  selectedDate = new Date();
  localStorage.setItem(LS_LAST_DATE, selectedDate.toISOString());
  sayForDate(selectedDate, {popup:true});
});

on("prevMonth","click", ()=> changeMonth(-1));
on("nextMonth","click", ()=> changeMonth(1));

on("favBtn","click", toggleFavorite);
on("favListBtn","click", showFavorites);
on("favMask","click", closeFavModal);
on("favModalClose","click", closeFavModal);

/* ğŸŒ¸ å§¨å¦ˆæœŸäº‹ä»¶ */
on("savePeriod","click", ()=>{
  const start = $("periodStart").value;
  const cycle = parseInt($("periodCycle").value) || 28;
  const duration = parseInt($("periodDuration").value) || 5;
  
  if(!start){
    setMiniTip("è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ");
    return;
  }
  
  savePeriodData({
    lastStart: new Date(start),
    cycle: cycle,
    duration: duration
  });
  
  setMiniTip("ğŸŒ¸ å§¨å¦ˆæœŸå·²ä¿å­˜!");
});

on("file","change", async (e)=>{
  const files = Array.from(e.target.files || []);
  if(files.length===0) return;
  await importFiles(files);
  buildCalendar();
  sayForDate(new Date(), {popup:true});
});

on("exportBtn","click", exportFeeds);
on("wipeBtn","click", wipeFeeds);

on("defaultTheme","change", ()=>{
  const v = $("defaultTheme") ? $("defaultTheme").value : "";
  localStorage.setItem(LS_DEFAULT_THEME, v);
  setMiniTip("é»˜è®¤ä¸»é¢˜å·²ä¿å­˜ã€‚");
});

on("specialClose","click", closeSpecialModal);
on("specialMask","click", closeSpecialModal);
on("specialWriteBtn","click", ()=>{
  if(!lastSpecialContext) return;
  showReply(lastSpecialContext.text, lastSpecialContext.meta);
  closeSpecialModal();
  setMiniTip("ğŸ’Œ å·²å†™è¿›å›ä¿¡æ¡†ã€‚");
});
on("specialAgainBtn","click", rerollSpecial);

(function init(){
  updateCounts();
  refreshDefaultThemeSelect();
  restoreLastReply();
  updateCheckIn();
  updateVisits();
  updateFavCount();
  updatePeriodPredict();

  // åŠ è½½å§¨å¦ˆæœŸæ•°æ®
  const periodData = loadPeriodData();
  if(periodData && periodData.lastStart){
    const d = periodData.lastStart;
    $("periodStart").value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    $("periodCycle").value = periodData.cycle;
    $("periodDuration").value = periodData.duration;
  }

  if(localStorage.getItem(LS_AUDIO_INIT) === "1"){
    audioEnabled = true;
  }else{
    showAudioHint();
  }

  const raw = localStorage.getItem(LS_LAST_DATE);
  if(raw){
    try{ selectedDate = new Date(raw); }catch(e){}
  }else{
    selectedDate = new Date();
    localStorage.setItem(LS_LAST_DATE, selectedDate.toISOString());
  }

  buildYearMonth();
  buildCalendar();

  on("yearSel","change", ()=>{
    const y = Number($("yearSel").value);
    current = new Date(y, current.getMonth(), 1);
    buildCalendar();
  });
  on("monthSel","change", ()=>{
    const m = Number($("monthSel").value)-1;
    current = new Date(current.getFullYear(), m, 1);
    buildCalendar();
  });

  const fp = $("feedPanel");
  if(fp) fp.open = false;

  const feeds = loadFeeds();
  if(feeds.length>0){
    const hit = findSpecialForDate(new Date());
    if(hit){
      sayForDate(new Date(), {popup:true});
    }
  }
})();
</script>
</body>
</html>
